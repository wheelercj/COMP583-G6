<!DOCTYPE html>
<html>

  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MakeMeShort</title>
    <link rel="icon" type="image/x-icon" href="/public/images/favicon.ico">
    <link rel="stylesheet" href="/public/css/index.css">
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  </head>

  <body>
    <header>
      <a href="/"><img src="/public/images/icons8-link-100.png" style="text-align: left;" /></a>
      <nav style="text-align: right;">
        <ul>
          <li><a href="/public/about.html">About</a></li>
          <li><a href="/public/custom-url.html">Custom URL</a></li>
          <li><a href="/public/metrics.html">Metrics</a></li>
        </ul>
      </nav>
    </header>

    <div class="container">
      <form action="" class="searchbar" id="searchbar" onsubmit="return false">
        <input id="searchbar_inputfield" type="text" placeholder="Original Link here">
        <button onclick="createShortURL()"><img src="/public/images/search_icon.png" alt=""></button>
      </form>
      <div>
        <p id="result"></p>
        <p id="return_extvalid_p"></p>
      </div>
      <div class="customInput">https://makemeshort.buzz/ <input id="custom_ext" type="text"> </div>
      <button class="customBtn" id="customBtn" onclick="createCustomURL()">Make Custom Short Link</button>
      <div class="og_link">
        <p id="og_link"></p>
      </div>
      <div class="created_msg" id="created_msg">
        <div class="created_link">
          <p id="return_link"></p>
        </div>
      </div>
      <footer>
        <a target="_blank" href="https://icons8.com/icon/113527/link">Link</a> icon by <a target="_blank"
          href="https://icons8.com">Icons8</a>
      </footer>

      <script>
        src = "https://cdn.jsdelivr.net/npm/axios@1.1.2/dist/axios.min.js"
        const baseUrl = "https://makemeshort.buzz";  // change to "http://localhost:3306" for local testing
        const createURLBtn = document.getElementById("createURL_btn");
        const result = document.getElementById("result");
        const searchbar_inputfield = document.getElementById("searchbar_inputfield");
        const custom_ext = document.getElementById("custom_ext");
        const return_extvalid_p = document.getElementById("return_extvalid_p")
        const og_link_p = document.getElementById("og_link")
        const return_link_p = document.getElementById("return_link")

        const isValidUrl = urlString => {
          var urlPattern = new RegExp('^(https?:\\/\\/)?' + // validate protocol
            '((([a-z\\d]([a-z\\d-]*[a-z\\d])*)\\.)+[a-z]{2,}|' + // validate domain name
            '((\\d{1,3}\\.){3}\\d{1,3}))' + // validate OR ip (v4) address
            '(\\:\\d+)?(\\/[-a-z\\d%_.~+]*)*' + // validate port and path
            '(\\?[;&a-z\\d%_.~+=-]*)?' + // validate query string
            '(\\#[-a-z\\d_=.]*)?$', 'i'); // validate fragment locator
          return !!urlPattern.test(urlString);
        }

        function createShortURL() {
          if (!isValidUrl(searchbar_inputfield.value)) {
            result.innerHTML = searchbar_inputfield.value + " is not valid";
            document.getElementById("created_msg").style.height = 0
          }
          else {
            postGuestUrl(searchbar_inputfield.value).then((data) => {
              result.innerHTML = `<a href="https://makemeshort.buzz/${data}">https://makemeshort.buzz/${data}</a>`;
            }).catch((error) => {
              console.log(error);
            });
          }
          searchbar_inputfield.value = "";
          document.getElementById("searchbar")[0].placeholder = "Original Link here";
          og_link_p.style.height = 0
          og_link_p.style.paddingBottom = 0
          document.getElementById("created_msg").style.height = 0
        }
        async function postGuestUrl(originalUrl) {
          const json = {
            "url": originalUrl,
          }
          try {
            const response = await axios.post(`${baseUrl}/v1/url`, json);
            console.log(`status: ${response.status}`);
            if (response.status >= 200 && response.status < 300) {
              console.log(`data: ${response.data}`);
              return response.data;
            } else {
              console.log(`status: ${response.status}`);
            }
          } catch (error) {
            console.log(error);
          }
        }

        function createCustomURL() {
          if (!isValidUrl(searchbar_inputfield.value) || !isValidShortUrl(custom_ext.value)) {
            if (!isValidUrl(searchbar_inputfield.value)) {
              result.innerHTML = "Not a valid URL: \" " + searchbar_inputfield.value + "\"";
              searchbar_inputfield.value = "";
              document.getElementById("created_msg").style.height = 0
              og_link_p.style.height = 0
              og_link_p.style.paddingBottom = 0
            }
            if (!isValidShortUrl(custom_ext.value)) {
              return_extvalid_p.innerHTML = "Extension must be <30 characters A-Z, a-z, and -, _ ONLY!";
              document.getElementById("created_msg").style.height = 0
            }
            else {
              return_extvalid_p.innerHTML = ""
            }
          }
          else {
            postCustomGuestUrl(searchbar_inputfield.value, custom_ext.value).then((data) => {
              result.innerHTML = `<a href="https://makemeshort.buzz/${data}">https://makemeshort.buzz/${data}</a>`;
            }).catch((error) => {
              console.log(error);
            });
            og_link_p.innerHTML = searchbar_inputfield.value
            og_link_p.style.paddingBottom = "7px"

            return_link_p.innerHTML = "https://makemeshort.buzz/" + custom_ext.value
            // set height to show msg
            document.getElementById("created_msg").style.height = "auto"
            og_link_p.style.height = "auto"
          }
          searchbar_inputfield.value = "";
          custom_ext.value = ""
          document.getElementById("searchbar")[0].placeholder = "Original Link here";
        }

        function isValidShortUrl(shortUrl) {
          return (
            shortUrl !== undefined
            && shortUrl.length <= 30
            && shortUrl.length > 0
            && /^[a-zA-Z0-9_-]+$/.test(shortUrl)
          )
        }

        async function postCustomGuestUrl(originalUrl, customUrl) {
          const json = {
            "url": originalUrl,
            "custom": customUrl
          }
          try {
            const response = await axios.post(`${baseUrl}/v1/url`, json);
            console.log(`status: ${response.status}`);
            if (response.status >= 200 && response.status < 300) {
              console.log(`data: ${response.data}`);
              return response.data;
            } else {
              console.log(`status: ${response.status}`);
            }
          }
          catch (error) {
            console.log(error);
          }
        }

      </script>
  </body>

</html>
