<!DOCTYPE html>
<html>

  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MakeMeShort</title>
    <link rel="icon" type="image/x-icon" href="/public/images/favicon.ico">
    <link rel="stylesheet" href="/public/css/index.css">
    <link rel="stylesheet" href="/public/css/common.css">
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  </head>

  <body>
    <header>
      <a href="/"><img src="/public/images/icons8-link-100.png" /></a>
      <nav>
        <ul>
          <li style="text-decoration: underline;"><a href="/public/index.html">Home</a></li>
          <li><a href="/public/about.html">About</a></li>
          <li><a href="/public/custom-url.html">Custom URL</a></li>
          <li><a href="/public/metrics.html">Metrics</a></li>
        </ul>
      </nav>
    </header>

    <div class="container">
      <form action="" class="searchbar" id="searchbar" onsubmit="return false">
        <input id="searchbar_inputfield" type="text" placeholder="Paste a long link here">
        <button onclick="createShortURL()"><img src="/public/images/search_icon.png" alt=""></button>
      </form>
      <p id="result"></p>
      <p id="returnURL_p"></p>

      <script>
        src = "https://cdn.jsdelivr.net/npm/axios@1.1.2/dist/axios.min.js"
        const baseUrl = "https://makemeshort.buzz";  // change to "http://localhost:3306" for local testing
        const createURLBtn = document.getElementById("createURL_btn");
        const result = document.getElementById("result");
        const searchbar_inputfield = document.getElementById("searchbar_inputfield");
        const isValidUrl = urlString => {
          var urlPattern = new RegExp('^(https?:\\/\\/)?' + // validate protocol
            '((([a-z\\d]([a-z\\d-]*[a-z\\d])*)\\.)+[a-z]{2,}|' + // validate domain name
            '((\\d{1,3}\\.){3}\\d{1,3}))' + // validate OR ip (v4) address
            '(\\:\\d+)?(\\/[-a-z\\d%_.~+]*)*' + // validate port and path
            '(\\?[;&a-z\\d%_.~+=-]*)?' + // validate query string
            '(\\#[-a-z\\d_=.]*)?$', 'i'); // validate fragment locator
          return !!urlPattern.test(urlString);
        }

        function createShortURL() {
          if (!isValidUrl(searchbar_inputfield.value)) {
            result.innerHTML = searchbar_inputfield.value + " is not valid";
          }
          else {
            postUrl(searchbar_inputfield.value).then((data) => {
              result.innerHTML = `<a href="https://makemeshort.buzz/${data}">https://makemeshort.buzz/${data}</a>`;
            }).catch((error) => {
              console.log(error);
            });
          }
          searchbar_inputfield.value = "";
          document.getElementById("searchbar")[0].placeholder = "Paste a long link here";
        }

        async function postUrl(originalUrl, userId) {
          // userId is not required so users not logged in can create short links.
          const json = {
            "url": originalUrl,
            "userId": userId,
          }

          try {
            const response = await axios.post(`${baseUrl}/v1/url`, json);
            console.log(`status: ${response.status}`);
            if (response.status >= 200 && response.status < 300) {
              console.log(`data: ${response.data}`);
              return response.data;
            } else {
              console.log(`status: ${response.status}`);
            }
          } catch (error) {
            console.log(error);
          }
        }

      </script>
    </div>
    <footer>
      <a target="_blank" href="https://icons8.com/icon/113527/link">Link</a> icon by <a target="_blank"
        href="https://icons8.com">Icons8</a>
      <br />
      <br />
      <p>&copy; 2023 Jong Won Lim, Chris Wheeler, and Miroo Yum</p>
    </footer>
  </body>

</html>
